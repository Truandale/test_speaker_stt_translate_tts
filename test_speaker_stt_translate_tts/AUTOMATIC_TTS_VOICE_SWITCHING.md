# Автоматическое переключение TTS голосов

## Обзор
Реализована система автоматического переключения голосов TTS на основе языка переводимого текста, аналогично MORT. Система автоматически выбирает подходящий голос (английский или русский) для озвучивания переведенного текста.

## Архитектура

### TtsVoiceManager.cs
Центральный компонент для управления голосами TTS:

#### Основные методы:
- `LoadVoices()` - Загружает и категоризирует доступные голоса по языкам
- `SelectDefaultVoices()` - Выбирает оптимальные голоса по умолчанию на основе приоритетных имен
- `IsEnglishText(string text)` - Определяет язык текста (точная копия из MORT)
- `SelectVoiceForText(string text)` - Автоматически выбирает голос на основе языка
- `SpeakWithAutoVoice(string text)` - Озвучивает текст с автоматическим выбором голоса

#### Алгоритм выбора голосов:
1. **Английские голоса**: Приоритет по именам `david`, `zira`, `mark`, `english`
2. **Русские голоса**: Приоритет по именам `irina`, `pavel`, `russian`, `русский`
3. **Fallback**: Если приоритетный голос не найден, выбирается первый доступный

### Определение языка
Функция `IsEnglishText()` реализует эвристику из MORT:
```csharp
private bool IsEnglishText(string text)
{
    int latinCount = 0;
    int cyrillicCount = 0;
    
    foreach (char c in text)
    {
        if (c >= 'A' && c <= 'Z' || c >= 'a' && c <= 'z')
            latinCount++;
        else if (c >= 'А' && c <= 'Я' || c >= 'а' && c <= 'я')
            cyrillicCount++;
    }
    
    return latinCount > cyrillicCount;
}
```

## Интеграция в Form1.cs

### Инициализация
В `InitializeTTS()` добавлена инициализация TtsVoiceManager:
```csharp
ttsVoiceManager = new TtsVoiceManager(speechSynthesizer);
```

### Автоматический выбор голоса
В `SpeakText()` добавлен вызов:
```csharp
ttsVoiceManager.SelectVoiceForText(text);
```

## Принцип работы

1. **Анализ текста**: При поступлении текста для озвучивания анализируется соотношение латинских и кириллических символов
2. **Выбор голоса**: На основе анализа выбирается соответствующий голос (EN/RU)
3. **Автоматическое переключение**: Голос устанавливается только при необходимости (если отличается от текущего)
4. **Логирование**: Все переключения логируются для отладки

## Особенности реализации

### Совместимость с MORT
- Точная копия алгоритма `IsEnglishText()` из MORT
- Аналогичные приоритеты выбора голосов по именам
- Совместимая система инициализации голосов

### Оптимизация производительности
- Голос переключается только при необходимости
- Кэширование списков голосов при инициализации
- Минимальные накладные расходы на анализ текста

### Обработка ошибок
- Graceful fallback при отсутствии голосов
- Защита от исключений при переключении голосов
- Информативное логирование проблем

## Логи и отладка

### Примеры логов:
```
[TTS] Загружено голосов: RU=2, EN=3
[TTS] Выбраны голоса по умолчанию:
  EN: Microsoft David Desktop (en-US)
  RU: Microsoft Irina Desktop (ru-RU)
[TTS] Переключен голос: Microsoft David Desktop (en-US) (EN)
```

### Информация о состоянии:
```csharp
string voiceInfo = ttsVoiceManager.GetVoiceInfo();
// Результат: "EN: Microsoft David Desktop | RU: Microsoft Irina Desktop"
```

## Преимущества

1. **Автоматизация**: Пользователю не нужно вручную переключать голоса
2. **Качество**: Русский текст озвучивается русским голосом, английский - английским
3. **Производительность**: Минимальные накладные расходы на определение языка
4. **Надежность**: Устойчивость к отсутствию голосов определенного языка
5. **Совместимость**: Полная совместимость с подходом MORT

## Конфигурация

Система работает автоматически без дополнительной настройки. При необходимости можно:
- Получить списки доступных голосов через `GetAvailableVoices()`
- Установить конкретные голоса через `SetVoice()`
- Получить текущее состояние через `GetVoiceInfo()`