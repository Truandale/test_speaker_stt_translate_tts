# üöÄ –°–¢–ê–ë–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê STT‚Üí–ü–ï–†–ï–í–û–î‚ÜíTTS

## –û–±–∑–æ—Ä –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ö–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏–æ-–∑–∞—Ö–≤–∞—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:

### üéØ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- ‚úÖ **–î—Ä–æ–ø—ã –∞—É–¥–∏–æ** - event-driven WASAPI —Å –∫–æ—Ä–æ—Ç–∫–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é (20-50–º—Å)
- ‚úÖ **–°–º–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤** - –≥–æ—Ä—è—á–µ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –¥–∏–Ω–∞–º–∏–∫–æ–≤
- ‚úÖ **–î–∂–∏—Ç—Ç–µ—Ä/–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è** - bounded Channels —Å backpressure –∑–∞—â–∏—Ç–æ–π
- ‚úÖ **GC-–ø–∞—É–∑—ã** - ArrayPool –¥–ª—è –≤—Å–µ—Ö –±—É—Ñ–µ—Ä–æ–≤, –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∞–ª–ª–æ–∫–∞—Ü–∏–π
- ‚úÖ **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö
- ‚úÖ **–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å TTS** - –µ–¥–∏–Ω—ã–π –≤–æ—Ä–∫–µ—Ä —Å –æ—á–µ—Ä–µ–¥—å—é –∏ —É–º–Ω—ã–º —Ä–∞–∑–±–∏–µ–Ω–∏–µ–º

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. **StableAudioCapture** - –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∞—É–¥–∏–æ-–∑–∞—Ö–≤–∞—Ç
```csharp
// Event-driven –∑–∞—Ö–≤–∞—Ç —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
private WasapiLoopbackCapture _capture;
private readonly Channel<byte[]> _rawAudioChannel;

// MMCSS –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–æ–≤
private IntPtr _captureThreadHandle = AvSetMmThreadCharacteristics("Audio", out _);
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- üéß **Event-driven WASAPI** —Å –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é 30–º—Å
- üîÑ **–ì–æ—Ä—è—á–µ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- üìä **Bounded Channels** (64 —ç–ª–µ–º–µ–Ω—Ç–∞) —Å DropOldest
- üß† **ArrayPool** –¥–ª—è –Ω—É–ª—å-–∞–ª–ª–æ–∫–∞—Ü–∏–π –≤ –≥–æ—Ä—è—á–µ–º –ø—É—Ç–∏
- ‚ö° **MMCSS –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã** –¥–ª—è –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–æ–≤

### 2. **SlidingWindowAggregator** - –£–º–Ω–æ–µ –æ–∫–Ω–æ —Å VAD
```csharp
// –°–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ 3 —Å–µ–∫—É–Ω–¥—ã —Å –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ–º 0.5 —Å–µ–∫
private const float WINDOW_DURATION_SEC = 3.0f;
private const float OVERLAP_DURATION_SEC = 0.5f;
private const float RMS_THRESHOLD = 0.001f;
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- üéöÔ∏è **–°–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ** 3—Å —Å –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ–º 0.5—Å 
- üîá **–ë–∞–∑–æ–≤—ã–π VAD** –ø–æ RMS + —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏
- üîÄ **–£–º–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ** —Ç–µ–∫—Å—Ç–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚è∞ **–¢—Ä–∏–≥–≥–µ—Ä—ã**: —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞, –ø–∞—É–∑–∞ >600–º—Å, –∏–Ω—Ç–µ—Ä–≤–∞–ª 1.5—Å
- üìù **–ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞** –¥–æ 400 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ TTS

### 3. **StableTtsEngine** - –ù–∞–¥–µ–∂–Ω–∞—è –æ–∑–≤—É—á–∫–∞
```csharp
// –ï–¥–∏–Ω—ã–π –≤–æ—Ä–∫–µ—Ä —Å bounded –æ—á–µ—Ä–µ–¥—å—é
private readonly Channel<TtsRequest> _ttsQueue;
private const int MAX_TEXT_LENGTH = 500;
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üé§ **–ï–¥–∏–Ω—ã–π –≤–æ—Ä–∫–µ—Ä** - –Ω–µ—Ç –Ω–∞–∫–ª–∞–¥—ã–≤–∞–Ω–∏—è –æ–∑–≤—É—á–µ–∫
- üìù **–£–º–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ** –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –Ω–∞ —á–∞—Å—Ç–∏ ‚â§500 —Å–∏–º–≤–æ–ª–æ–≤
- üö´ **Backpressure** - –¥—Ä–æ–ø–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏
- üåê **–ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–æ–≤** —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≥–æ–ª–æ—Å–æ–≤
- ‚èπÔ∏è **Graceful –æ—Ç–º–µ–Ω–∞** —á–µ—Ä–µ–∑ CancellationToken

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
üéß WASAPI Loopback (30–º—Å)
    ‚Üì (ArrayPool –±—É—Ñ–µ—Ä—ã)
üìä Raw Audio Channel (bounded 64)
    ‚Üì (MediaFoundation —Ä–µ—Å–µ–º–ø–ª–µ—Ä)
üéµ 16kHz Mono Float Channel
    ‚Üì (—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ 3—Å)
ü™ü SlidingWindow Aggregator
    ‚Üì (Whisper STT)
üìù STT Results Channel
    ‚Üì (Google Translate)
üåê Translation Channel  
    ‚Üì (—É–º–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ)
üéôÔ∏è Stable TTS Engine
    ‚Üì (Windows SAPI)
üîä Audio Output
```

---

## ‚öôÔ∏è –ö–ª—é—á–µ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **ArrayPool<byte/float>** - –Ω—É–ª—å –∞–ª–ª–æ–∫–∞—Ü–∏–π –≤ –∞—É–¥–∏–æ –ø—É—Ç–∏
- **MediaFoundationResampler** - –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ—Å–µ–º–ø–ª–∏–Ω–≥ –¥–æ 16kHz 
- **MMCSS –ø–æ—Ç–æ–∫–∏** - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **Throttling** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI (200–º—Å)
- **Backpressure** - –∑–∞—â–∏—Ç–∞ –æ—Ç —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏—è –ø–∞–º—è—Ç–∏

### üîß –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å  
- **–ì–æ—Ä—è—á–µ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **Exception handling** –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ
- **Graceful degradation** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **Resource cleanup** –≤ Dispose patterns
- **Thread-safe** –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Channels

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- **–ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∞—É–¥–∏–æ** (RMS, –∫–ª–∏–ø–ø–∏–Ω–≥, —Å–ø–µ–∫—Ç—Ä)
- **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** (–¥—Ä–æ–ø—ã, —É—Å–ø–µ—à–Ω–æ—Å—Ç—å, –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
- **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## üéÆ API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –ó–∞–ø—É—Å–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
```csharp
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
await stableAudioCapture.StartCaptureAsync();

// –°–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
stableAudioCapture.OnStatusChanged += (status) => LogMessage(status);
slidingWindowAggregator.OnTextReady += async (text) => await ProcessText(text);
stableTtsEngine.OnSpeechCompleted += (text) => LogMessage($"–û–∑–≤—É—á–µ–Ω–æ: {text}");
```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞
```csharp
// Graceful –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å flush –±—É—Ñ–µ—Ä–æ–≤
await stableAudioCapture.StopCaptureAsync();
await slidingWindowAggregator.FlushAsync();
await stableTtsEngine.ClearQueueAsync();

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ IDisposable
stableAudioCapture.Dispose();
```

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚ùå –ß–∞—Å—Ç—ã–µ –¥—Ä–æ–ø—ã –∞—É–¥–∏–æ –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚ùå –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏  
- ‚ùå –ù–∞–∫–ª–∞–¥—ã–≤–∞–Ω–∏–µ TTS –æ–∑–≤—É—á–µ–∫
- ‚ùå –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (GC –ø–∞—É–∑—ã)
- ‚ùå –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω—ã–π –∑–∞—Ö–≤–∞—Ç** –±–µ–∑ –¥—Ä–æ–ø–æ–≤ –∏ –¥–∂–∏—Ç—Ç–µ—Ä–∞
- ‚úÖ **–û—Ç–∑—ã–≤—á–∏–≤—ã–π UI** - –≤—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ
- ‚úÖ **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–∑–≤—É—á–∫–∞** –±–µ–∑ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
- ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ GC –ø–∞—É–∑—ã** —á–µ—Ä–µ–∑ ArrayPool
- ‚úÖ **–ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø—Ä–∏ —Å–±–æ—è—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

---

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Windows 10+ (–¥–ª—è WASAPI Loopback)
- .NET 8.0
- NAudio 2.2.1+
- Whisper.NET
- 4GB+ RAM (–¥–ª—è Whisper –º–æ–¥–µ–ª–∏)

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```xml
<PackageReference Include="NAudio" Version="2.2.1" />
<PackageReference Include="NAudio.Wasapi" Version="2.2.1" />
<PackageReference Include="Whisper.net" Version="1.4.7" />
<PackageReference Include="System.Threading.Channels" Version="8.0.0" />
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```csharp
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
private const int CHANNEL_CAPACITY = 64;           // –†–∞–∑–º–µ—Ä –∫–∞–Ω–∞–ª–æ–≤
private const int TARGET_SAMPLE_RATE = 16000;      // –ß–∞—Å—Ç–æ—Ç–∞ –¥–ª—è Whisper
private const int AUDIO_LATENCY_MS = 30;           // –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å WASAPI
private const float WINDOW_DURATION_SEC = 3.0f;    // –†–∞–∑–º–µ—Ä –æ–∫–Ω–∞ STT
private const int MAX_TEXT_LENGTH = 500;           // –ú–∞–∫—Å–∏–º—É–º –¥–ª—è TTS

// –ü–æ—Ä–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
private const float RMS_THRESHOLD = 0.001f;        // –ü–æ—Ä–æ–≥ —Ç–∏—à–∏–Ω—ã
private const float SILENCE_THRESHOLD_SEC = 0.6f;  // –ü–∞—É–∑–∞ –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞
```

---

## üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **–ö–æ–º–ø–∏–ª—è—Ü–∏—è:**
```bash
dotnet build --configuration Release
```

2. **–ó–∞–ø—É—Å–∫:**
- –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "Start Capture" 
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –≤ –ª–æ–≥–∞—Ö

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- –õ–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ TTS –∏ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∞—É–¥–∏–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞

---

*üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é!*